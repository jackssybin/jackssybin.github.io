<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#f9f9f9" />
    <title>jackssybin网址导航</title>
    <link rel="shortcut icon" href="/assets/images/favicon.png" />
    <meta name="keywords" content="jackssybin网址导航" />
    
    <meta name="baidu-site-verification" content="codeva-cCAOSG8MBO" />
    
    <link rel="stylesheet" id="block-library-css"
        href="/assets/css/block-library.min-5.6.2.css" type="text/css" media="all" />
    <link rel="stylesheet" id="iconfont-css" href="/assets/css/iconfont-3.03029.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="bootstrap-css" href="/assets/css/bootstrap.min-4.3.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="fancybox-css" href="/assets/css/fancybox.min-3.5.7.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="iowen-css" href="/assets/css/style-3.03029.1.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="custom-css" href="/assets/css/custom-style.css"
        type="text/css" media="all" />
    <link rel="stylesheet" id="fortawesome-css" href="/assets/fontawesome-5.15.4/css/all.min.css" type="text/css" />
    <script type="text/javascript" src="/assets/js/jquery.min-3.2.1.js" id="jquery-js"></script>
    <script type="text/javascript" src="/assets/js/content-search.js"  id="content-search-js"></script>
    
    <script>
        
        var _hmt = _hmt || [];
            (function () {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?efccc04cb44fc49faddac5876180b369";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            })();
        
    </script>
    
    
     
    
    
    
    
</head>


<div class="main-content flex-fill grid-bg">
    <div class="big-header-banner">
        <div id="header" class="page-header sticky">
            <div class="navbar navbar-expand-md">
                <div class="container-fluid p-0">

                    <a href="" class="navbar-brand d-md-none" title="jackssybin网址导航">
                        <img src="/assets/images/bt.png" class="logo-light"
                            alt="jackssybin网址导航">
                        <img src="/assets/images/bt.png" class="logo-dark d-none"
                            alt="jackssybin网址导航">
                    </a>

                    <div class="collapse navbar-collapse order-2 order-md-1">
                        <div class="header-mini-btn">
                            <label>
                                <input id="mini-button" type="checkbox">
                                <svg viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                    <path class="line--1" d="M0 40h62c18 0 18-20-17 5L31 55"></path>
                                    <path class="line--2" d="M0 50h80"></path>
                                    <path class="line--3" d="M0 60h62c18 0 18 20-17-5L31 45"></path>
                                </svg>
                            </label>

                        </div>

                        <ul class="navbar-nav site-menu" style="margin-right: 16px;">
                        
			<li >
				<a href="./">
                                    <i class="fa fa-home fa-lg mr-2"></i>
                                    <span>首页</span>
                                </a>
				<ul class="sub-menu">
				
				</ul>
			    </li>
			
			<li >
				<a href="https://www.jackssybin.cn/">
                                    <i class="fa fa-book fa-lg mr-2"></i>
                                    <span>作者</span>
                                </a>
				<ul class="sub-menu">
				
				</ul>
			    </li>
			
			<li class="menu-item-has-children">
				<a href="">
                                    <i class="fa fa-cog fa-lg mr-2"></i>
                                    <span>配置</span>
                                </a>
				<ul class="sub-menu">
				
				    <li><a href="#">源码</a></li>
				
				    <li><a href="#">图标</a></li>
				
				</ul>
			    </li>
			
			</ul>

                        
                        <div class="rounded-circle weather">
                            <div id="he-plugin-simple" style="display: contents;"></div>
                            <script>WIDGET = {
                                    CONFIG: {
                                        "modules": "01234",
                                        "background": 5,
                                        "tmpColor": "E4C600",
                                        "tmpSize": 14,
                                        "cityColor": "E4C600",
                                        "citySize": 14,
                                        "aqiColor": "#E4C600",
                                        "aqiSize": 14,
                                        "weatherIconSize": 24,
                                        "alertIconSize": 18,
                                        "padding": "10px 10px 10px 10px",
                                        "shadow": "1",
                                        "language": "auto",
                                        "borderRadius": 5,
                                        "fixed": "false",
                                        "vertical": "middle",
                                        "horizontal": "left",
                                        "key": "085791e805a24491b43b06cf58ab31e7"
                                    }
                                }
                            </script>
                            <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script>
                        </div>
                        
                    </div>

                    <ul class="nav navbar-menu text-xs order-1 order-md-2">
                        
                        
                        <li class="nav-item mr-3 mr-lg-0 d-none d-lg-block">
                            <script>
                                fetch('https://v1.hitokoto.cn')
                                    .then(response => response.json())
                                    .then(data => {
                                    const hitokoto = document.getElementById('hitokoto_text')
                                    hitokoto.href = 'https://hitokoto.cn/?uuid=' + data.uuid
                                    hitokoto.innerText = data.hitokoto
                                    })
                                    .catch(console.error)
                            </script>                           
                            <div id="hitokoto"><a href="#" target="_blank" id="hitokoto_text">疏影横斜水清浅，暗香浮动月黄昏。</a></div>
                        </li>
                        
                        
                        <li class="nav-search ml-3 ml-md-4">
                            <a href="javascript:" data-toggle="modal" data-target="#search-modal"><i
                                    class="iconfont icon-search icon-2x"></i></a>
                        </li>
                        <li class="nav-item d-md-none mobile-menu ml-3 ml-md-4">
                            <a href="javascript:" id="sidebar-switch" data-toggle="modal"
                                data-target="#sidebar"><i class="iconfont icon-classification icon-2x"></i></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="placeholder" style="height:74px"></div>
    </div>


<body class="page-body boxed-container">
    <main role="main" class="flex-shrink-0">
    <div class="container">
        <h1 class="mt-5"></h1>
        <div class="content">
            <h2 id="permalink-articles201909181568819118263html">title: 终极分库分表方案
date: &lsquo;2019-09-18 23:05:18&rsquo;
updated: &lsquo;2019-09-18 23:24:27&rsquo;
tags: [java, 数据库, 分库分表, 高并发]
permalink: /articles/2019/09/18/1568819118263.html</h2>
<p><img src="https://img.hacpai.com/bing/20171107.jpg?imageView2/1/w/960/h/540/interlace/1/q/100" alt=""></p>
<ul>
<li>一、数据库瓶颈
<ul>
<li>1、IO瓶颈</li>
<li>2、CPU瓶颈</li>
</ul>
</li>
<li>二、分库分表</li>
<li>三、分库分表工具</li>
<li>四、分库分表步骤</li>
<li>五、分库分表问题</li>
<li>六、分库分表总结</li>
<li>七、分库分表示例</li>
</ul>
<h2 id="一数据库瓶颈">一、数据库瓶颈</h2>
<pre tabindex="0"><code>不管是IO瓶颈，还是CPU瓶颈，最终都会导致数据库的活跃连接数增加，进而逼近甚至达到数据库可承载活跃连接数的阈值。
<p>在业务Service来看就是，可用数据库连接少甚至无连接可用。接下来就可以想象了吧（并发量、吞吐量、崩溃）。
</code></pre><h3 id="1io瓶颈">1、IO瓶颈</h3></p>
<pre tabindex="0"><code>第一种：磁盘读IO瓶颈，热点数据太多，数据库缓存放不下，每次查询时会产生大量的IO，降低查询速度 -&gt; 分库和垂直分表。

第二种：网络IO瓶颈，请求的数据太多，网络带宽不够 -&gt; 分库。
</code></pre><h3 id="2cpu瓶颈">2、CPU瓶颈</h3>
<pre tabindex="0"><code>第一种：SQL问题，如SQL中包含join，group by，order by，非索引字段条件查询等，增加CPU运算的操作 -&gt; SQL优化，建立合适的索引，在业务Service层进行业务计算。

第二种：单表数据量太大，查询时扫描的行太多，SQL效率低，CPU率先出现瓶颈 -&gt; 水平分表。
</code></pre><h2 id="二分库分表">二、分库分表</h2>
<h3 id="1水平分库">1、水平分库</h3>
<p><img src="https://img.hacpai.com/file/2019/09/1-5c4b1e2c.jpg" alt="1.jpg">
1.概念：以字段为依据，按照一定策略（hash、range等），将一个库中的数据拆分到多个库中。</p>
<p>2.结果：</p>
<ul>
<li>每个库的结构都一样;</li>
<li>每个库的数据都不一样，没有交集;</li>
<li>所有库的并集是全量数据;
3.场景：系统绝对并发量上来了，分表难以根本上解决问题，并且还没有明显的业务归属来垂直分库。</li>
</ul>
<p>4.分析：库多了，io和cpu的压力自然可以成倍缓解。</p>
<h3 id="2水平分表">2、水平分表</h3>
<p><img src="https://img.hacpai.com/file/2019/09/2-a51c2fe7.jpg" alt="2.jpg"></p>
<p>1.概念：以字段为依据，按照一定策略（hash、range等），将一个表中的数据拆分到多个表中。</p>
<p>2.结果：</p>
<p>每个表的结构都一样
每个表的数据都不一样，没有交集;
所有表的并集是全量数据;
3.场景：系统绝对并发量并没有上来，只是单表的数据量太多，影响了SQL效率，加重了CPU负担，以至于成为瓶颈。</p>
<p>4.分析：表的数据量少了，单次SQL执行效率高，自然减轻了CPU的负担。</p>
<h3 id="3垂直分库">3、垂直分库</h3>
<p><img src="https://img.hacpai.com/file/2019/09/3-d317985f.jpg" alt="3.jpg"></p>
<p>1.概念：以表为依据，按照业务归属不同，将不同的表拆分到不同的库中。</p>
<p>2.结果：</p>
<ul>
<li>每个库的结构都不一样；</li>
<li>每个库的数据也不一样，没有交集；</li>
<li>所有库的并集是全量数据；
3.场景：系统绝对并发量上来了，并且可以抽象出单独的业务模块。
4.分析：到这一步，基本上就可以服务化了。</li>
</ul>
<p>例如，随着业务的发展一些公用的配置表、字典表等越来越多，这时可以将这些表拆到单独的库中，甚至可以服务化。再有，随着业务的发展孵化出了一套业务模式，这时可以将相关的表拆到单独的库中，甚至可以服务化。</p>
<h3 id="4垂直分表">4、垂直分表</h3>
<p><img src="https://img.hacpai.com/file/2019/09/4-37e74d45.jpg" alt="4.jpg"></p>
<p>1.概念：以字段为依据，按照字段的活跃性，将表中字段拆到不同的表（主表和扩展表）中。</p>
<p>2.结果：</p>
<ul>
<li>每个表的结构都不一样；</li>
<li>每个表的数据也不一样，一般来说，每个表的字段至少有一列交集，一般是主键，用于关联数据；</li>
<li>所有表的并集是全量数据；
3.场景：系统绝对并发量并没有上来，表的记录并不多，但是字段多，并且热点数据和非热点数据在一起，单行数据所需的存储空间较大。以至于数据库缓存的数据行减少，查询时会去读磁盘数据产生大量的随机读IO，产生IO瓶颈。</li>
</ul>
<p>4.分析：可以用列表页和详情页来帮助理解。垂直分表的拆分原则是将热点数据（可能会冗余经常一起查询的数据）放在一起作为主表，非热点数据放在一起作为扩展表。</p>
<p>这样更多的热点数据就能被缓存下来，进而减少了随机读IO。拆了之后，要想获得全部数据就需要关联两个表来取数据。但记住，千万别用join，因为join不仅会增加CPU负担并且会讲两个表耦合在一起（必须在一个数据库实例上）。关联数据，应该在业务Service层做文章，分别获取主表和扩展表数据然后用关联字段关联得到全部数据。</p>
<h2 id="三分库分表工具">三、分库分表工具</h2>
<h3 id="1-sharding-spherejar前身是sharding-jdbc">1. sharding-sphere：jar，前身是sharding-jdbc；</h3>
<h3 id="1-tddljartaobao-distribute-data-layer">1. TDDL：jar，Taobao Distribute Data Layer；</h3>
<h3 id="1-mycat中间件">1. Mycat：中间件。</h3>
<p>注：工具的利弊，请自行调研，官网和社区优先。</p>
<h2 id="四分库分表步骤">四、分库分表步骤</h2>
<p>根据容量（当前容量和增长量）评估分库或分表个数 -&gt; 选key（均匀）-&gt; 分表规则（hash或range等）-&gt; 执行（一般双写）-&gt; 扩容问题（尽量减少数据的移动）。</p>
<h2 id="五分库分表问题">五、分库分表问题</h2>
<h3 id="1非partition-key的查询问题水平分库分表拆分策略为常用的hash法">1、非partition key的查询问题（水平分库分表，拆分策略为常用的hash法）**</h3>
<p>端上除了partition key只有一个非partition key作为条件查询</p>
<ul>
<li>
<p>映射法
<img src="https://img.hacpai.com/file/2019/09/5-960cbd5a.jpg" alt="5.jpg"></p>
</li>
<li>
<p>基因法</p>
</li>
</ul>
<p><img src="https://img.hacpai.com/file/2019/09/6-6984aa8a.jpg" alt="6.jpg"></p>
<p>注：写入时，基因法生成userid，如图。关于xbit基因，例如要分8张表，23=8，故x取3，即3bit基因。根据userid查询时可直接取模路由到对应的分库或分表。</p>
<p>根据username查询时，先通过usernamecode生成函数生成username_code再对其取模路由到对应的分库或分表。id生成常用snowflake算法。</p>
<p>端上除了partition key不止一个非partition key作为条件查询</p>
<ul>
<li>
<p>映射法
<img src="https://img.hacpai.com/file/2019/09/7-33a425b3.jpg" alt="7.jpg"></p>
</li>
<li>
<p>冗余法
<img src="https://img.hacpai.com/file/2019/09/8-56e105ce.jpg" alt="8.jpg"></p>
</li>
</ul>
<p>注：按照orderid或buyerid查询时路由到dbobuyer库中，按照sellerid查询时路由到dbo_seller库中。感觉有点本末倒置！有其他好的办法吗？改变技术栈呢？</p>
<p>后台除了partition key还有各种非partition key组合条件查询</p>
<ul>
<li>
<p>NoSQL法
<img src="https://img.hacpai.com/file/2019/09/9-d839252c.jpg" alt="9.jpg"></p>
</li>
<li>
<p>冗余法
<img src="https://img.hacpai.com/file/2019/09/10-aee7d2fa.jpg" alt="10.jpg"></p>
</li>
</ul>
<h3 id="2非partition-key跨库跨表分页查询问题水平分库分表拆分策略为常用的hash法">2、非partition key跨库跨表分页查询问题（水平分库分表，拆分策略为常用的hash法）</h3>
<p>注：用NoSQL法解决（ES等）。</p>
<h3 id="3扩容问题水平分库分表拆分策略为常用的hash法">3、扩容问题（水平分库分表，拆分策略为常用的hash法）</h3>
<p>1.水平扩容库（升级从库法）
<img src="https://img.hacpai.com/file/2019/09/11-a6b40729.jpg" alt="11.jpg"></p>
<p>注：扩容是成倍的。</p>
<p>2.水平扩容表（双写迁移法）
<img src="https://img.hacpai.com/file/2019/09/12-d5bc1249.jpg" alt="12.jpg"></p>
<p>第一步：（同步双写）应用配置双写，部署；第二步：（同步双写）将老库中的老数据复制到新库中；第三步：（同步双写）以老库为准校对新库中的老数据；第四步：（同步双写）应用去掉双写，部署；</p>
<p>注：双写是通用方案。</p>
<h2 id="六分库分表总结">六、分库分表总结</h2>
<ol>
<li>分库分表，首先得知道瓶颈在哪里，然后才能合理地拆分（分库还是分表？水平还是垂直？分几个？）。且不可为了分库分表而拆分。</li>
<li>选key很重要，既要考虑到拆分均匀，也要考虑到非partition key的查询。</li>
<li>只要能满足需求，拆分规则越简单越好。</li>
</ol>
<p>转载:<a href="https://mp.weixin.qq.com/s/i2eXbU1xrqJY51ETIPs0dw">https://mp.weixin.qq.com/s/i2eXbU1xrqJY51ETIPs0dw</a></p>

        </div>
    </div>
    </main>

    <style>
        .content {
            font-size: 1.25rem;
          }
          
          .content h1,
          .content h2,
          .content h3,
          .content h4 {
            margin: 15px 10px 5px;
          }
          
    </style>

        <footer class="main-footer footer-type-1 text-xs">
            <div id="footer-tools" class="d-flex flex-column">
                <a href="javascript:" id="go-to-up" class="btn rounded-circle go-up m-1" rel="go-top">
                    <i class="iconfont icon-to-up"></i>
                </a>
                
                <a href="javascript:" data-toggle="modal" data-target="#search-modal" class="btn rounded-circle m-1"
                    rel="search" one-link-mark="yes">
                    <i class="iconfont icon-search"></i>
                </a>
                <a href="https://www.yuque.com/shenweiyan" class="btn rounded-circle kefu m-1" target="_blank" data-toggle="tooltip" data-placement="left" title="联系我们">
                    <i class="mode-ico iconfont icon-qq"></i>
                </a>
                
                
		<a href="javascript:" onclick="window.location.href='javascript:switchNightMode()'" class="btn rounded-circle switch-dark-mode m-1" id="yejian"
                    data-toggle="tooltip" data-placement="left" title="日间模式">
                    <i class="mode-ico iconfont icon-night"></i>
                </a>
                
            </div>
            <div class="footer-inner">
                <div class="footer-text">本站内容源自互联网，如有内容侵犯了你的权益，请联系删除相关内容，联系邮箱：jackxiazhou@yeah.net <br/>© 2023 - 2024 By <a href="https://github.com/shenweiyan/WebStack-Hugo">WebStack-Hugo</a> | <a href="https://www.bioitee.com/">Bio IT 爱好者</a> | <a href="http://beian.miit.gov.cn/">京ICP备17039180号-1</a><br/></div>
            </div>
        </footer>
    </div>
</div>


<script type='text/javascript' src='/assets/js/jquery.ui.touch-punch.min-0.2.2.js' id='jqueryui-touch-js'></script>
<script type='text/javascript' src='/assets/js/clipboard.min-5.6.2.js' id='clipboard-js'></script>
<script type='text/javascript' src='/assets/js/tooltip-extend.js' id='iplaycode-nav-js'></script>
<script type='text/javascript' id='popper-js-extra'>
 

var theme = {"ajaxurl":"","addico":"https:\/\/nav.baidu.cn\/wp-content\/themes\/onenav\/images\/add.png","order":"asc","formpostion":"top","defaultclass":"io-grey-mode","isCustomize":"1","icourl":"","icopng":".png","urlformat":"1","customizemax":"10","newWindow":"0","lazyload":"1","minNav":"1","loading":"1","hotWords":"baidu","classColumns":" col-sm-6 col-md-4 col-xl-5a col-xxl-6a ","apikey":"TWpBeU1UVTNOekk1TWpVMEIvZ1M2bFVIQllUMmxsV1dZelkxQTVPVzB3UW04eldGQmxhM3BNWW14bVNtWk4="};
 
</script>
<script type='text/javascript' src='/assets/js/popper.min.js' id='popper-js'></script>
<script type='text/javascript' src='/assets/js/bootstrap.min-4.3.1.js' id='bootstrap-js'></script>
<script type='text/javascript' src='/assets/js/theia-sticky-sidebar-1.5.0.js' id='sidebar-js'></script>
<script type='text/javascript' src='/assets/js/lazyload.min-12.4.0.js' id='lazyload-js'></script>
<script type='text/javascript' src='/assets/js/fancybox.min-3.5.7.js' id='lightbox-js-js'></script>

<script type='text/javascript' src='/assets/js/app-mini.js' id='appmini-js'></script>

<script type="text/javascript">
    $(document).ready(function(){
        var siteWelcome = $('#loading');
        siteWelcome.addClass('close');
        setTimeout(function() {
            siteWelcome.remove();
        }, 600);
    });
</script>
<script>        
    $(document).ready(function(){
        setTimeout(function () {
            if ($('a.smooth[href="' + window.location.hash + '"]')[0]) {
                $('a.smooth[href="' + window.location.hash + '"]').click();
            }else if (window.location.hash != '') {
                $("html, body").animate({
                    scrollTop: $(window.location.hash).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
        }, 300);
        $(document).on('click','a.smooth',function(ev) {
            if($('#sidebar').hasClass('show') && !$(this).hasClass('change-href')){
                $('#sidebar').modal('toggle');
            }
            if($(this).attr("href").substr(0, 1) == "#"){
                $("html, body").animate({
                    scrollTop: $($(this).attr("href")).offset().top - 90
                }, {
                    duration: 500,
                    easing: "swing"
                });
            }
            if($(this).hasClass('go-search-btn')){
                $('#search-text').focus();
            }
            if(!$(this).hasClass('change-href')){
                var menu =  $("a"+$(this).attr("href"));
                menu.click();
                toTarget(menu.parent().parent(),true,true);
            }
        });
        $(document).on('click','a.tab-noajax',function(ev) {
            var url = $(this).data('link');
            if(url)
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').show().attr('href', url);
            else
                $(this).parents('.d-flex.flex-fill.flex-tab').children('.btn-move.tab-move').hide();
        });
        
    });
</script>

<script>

(function(){
    if(document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") === ''){
        if(new Date().getHours() > 22 || new Date().getHours() < 6){
            document.body.classList.remove('io-black-mode');
            document.body.classList.add('io-grey-mode');
            document.cookie = "night=1;path=/";
            console.log('夜间模式开启');
        }else{
            document.body.classList.remove('night');
            document.cookie = "night=0;path=/";
            console.log('夜间模式关闭');
        }
    }else{
        var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
        if(night == '0'){
            document.body.classList.remove('night');
        }else if(night == '1'){
            document.body.classList.add('night');
        }
    }
})();

$("#search-bg").css("background-image", "url(assets\/images\/bg-dna.jpg)");   
function switchNightMode(){
    var night = document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/, "$1") || '0';
    if(night == '0'){
	$("#search-bg").css("background-image", "url(assets\/images\/bg-dna.jpg)");
        document.body.classList.remove('io-grey-mode');
        document.body.classList.add('io-black-mode');
        document.cookie = "night=1;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","日间模式");
        $(".mode-ico").removeClass("icon-night");
        $(".mode-ico").addClass("icon-light");
    }else{
	$("#search-bg").css("background-image", "url(assets\/images\/bg-dna.jpg)")
        document.body.classList.remove('io-black-mode');
        document.body.classList.add('io-grey-mode');
        document.cookie = "night=0;path=/"
        console.log(' ');
        $(".switch-dark-mode").attr("data-original-title","夜间模式");
        $(".mode-ico").removeClass("icon-light");
        $(".mode-ico").addClass("icon-night");
    }
}
</script>
</body>
</html>

